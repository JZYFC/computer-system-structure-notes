# 输入输出子系统

## 概述

### 一. 总线

#### 1. 总线定义、特点、实体

##### 定义

一组能为<font color=green>多个部件</font>分时共享的<font color=green>信息传送线路</font>

##### 特点

<font color=green>分时、共享</font>

发送部件通过三态门控制<font color=orange>分时发送</font>信息, 由打入脉冲将信息送入接受部件

##### 实体

一组传送线(数量)与相应控制逻辑

* 控制逻辑
  * CPU内设置控制逻辑
  * 设置总线控制器

#### 2. 总线分类

##### (1) 按功能(层次)分类

1. CPU内总线——ALU总线  
    CPU内芯片与ALU互联的总线  
2. 局部总线——片级总线  
    (可有效缓解系统总线的瓶颈问题, 如GPU等)  
    插件板内各芯片互联的总线  
3. 系统总线——板级总线  
    计算机系统内各功能部件之间, 或各插件板之间互联的总线
4. 外总线——通信总线  
    计算机系统之间, 或计算机系统与其他系统之间的总线

![各总线示例](pics/%E6%A6%82%E8%BF%B0/%E5%90%84%E6%80%BB%E7%BA%BF.png)

##### (2) 按时序控制方式划分

###### a. 同步总线

由<font color="green">统一时序</font>控制总线传送操作

在固定时钟周期内完成数据传送，由同步脉冲定时打入

![同步总线例](pics/%E6%A6%82%E8%BF%B0/%E5%90%8C%E6%AD%A5%E6%80%BB%E7%BA%BF%E4%BE%8B.png)

###### b. 异步总线

无固定时钟周期划分，总线周期时间由传送实际需要决定；以<font color="green">异步应答</font>方式控制总线传送操作

![异步总线例](pics/%E6%A6%82%E8%BF%B0/%E5%BC%82%E6%AD%A5%E6%80%BB%E7%BA%BF%E4%BE%8B.png)

上图中的主从设备是基于谁拥有总线控制权, 而不是以发送方和接收方的身份决定

从同步表明信息已发送完成, 可以关闭主同步信号

根据主、从设备的请求信号、回答信号及设备自身定时的关系，异步应答分为三类

* 不互锁:  
    ![不互锁](pics/%E6%A6%82%E8%BF%B0/%E5%BC%82%E6%AD%A5-%E4%B8%8D%E4%BA%92%E9%94%81.png)
* 半互锁:  
    ![半互锁](pics/%E6%A6%82%E8%BF%B0/%E5%8D%8A%E4%BA%92%E9%94%81.png)
* 全互锁:  
    ![全互锁](pics/%E6%A6%82%E8%BF%B0/%E5%85%A8%E4%BA%92%E9%94%81.png)

##### (3) 扩展同步总线

以时钟周期为基础时序，允许总线周期中的时钟数可变

![扩展同步总线](pics/%E6%A6%82%E8%BF%B0/%E6%89%A9%E5%B1%95%E5%90%8C%E6%AD%A5%E6%80%BB%E7%BA%BF.png)

如果在T4时钟周期前发现无法及时完成, 会在T4前插入时钟周期Tw, 如此循环, 直到完成数据传送

注意插入的时间以时钟周期为基础

##### 注意概念区分

* 时钟周期：CPU一步操作(一次数据传送)时间  
* 总线周期：经过总线的一次数据传送(访存)时间  
  * 通常包含若干时钟周期  
  * （模型机的一个总线周期只包含一个时钟周期）  
* 工作周期：指令周期中的一个操作阶段  
  * 可包含多个总线周期  

##### (3) 按数据传送格式划分

###### 并行总线  

同时传送各位信息  

###### 串行总线  

分时逐位传送各位信息  
(远距离传送信息)

<font color="green">CPU内总线</font>：同步、并行  
<font color="green">系统总线</font>：同步、异步、扩展同步、并行  
<font color="green">外总线</font>：异步、并行、串行  

#### 3. 总线的仲裁

多个部件同时申请总线使用权时，对总线的使用权进行裁决

##### (1) 集中式仲裁

<font color=orange>总线控制逻辑集中在中央总裁器</font>

![集中式仲裁](pics/%E6%A6%82%E8%BF%B0/%E9%9B%86%E4%B8%AD%E5%BC%8F%E4%BB%B2%E8%A3%81.png)

###### a. 链式查询

![链式查询](pics/%E6%A6%82%E8%BF%B0/%E9%93%BE%E5%BC%8F%E6%9F%A5%E8%AF%A2.png)

总线授权信号被依次串行地传送到所连接的外围设备上进行比较, 确认发送请求的设备

设备的优先级固定，逻辑距离<font color="green">越近</font>的优先级<font color="green">越高</font>

###### b. 计数器定时查询方式总线仲裁

![计数器定时查询](pics/%E6%A6%82%E8%BF%B0/%E8%AE%A1%E6%95%B0%E5%99%A8%E5%AE%9A%E6%97%B6%E6%9F%A5%E8%AF%A2%E6%96%B9%E5%BC%8F.png)

当查询计数器计数值与发出请求的设备编号一致时，中止查询，该设备获总线控制权

计数器通过总线忙信号确认是否继续进行计数

<font color="green">优先级灵活</font>：计数器初值、设备编号可通过程序设定，优先次序可用程序控制

###### c. 独立请求方式总线仲裁

![独立请求](pics/%E6%A6%82%E8%BF%B0/%E7%8B%AC%E7%AB%8B%E8%AF%B7%E6%B1%82%E6%96%B9%E5%BC%8F%E6%80%BB%E7%BA%BF%E4%BB%B2%E8%A3%81.png)

各设备均通过专用请求信号线与仲裁器连接，且通过独立的授权信号线接收总线批准信号

效率高

##### (2) 分布式仲裁

各设备有仲裁电路，需要控制总线时，自行判定是否能获得总线权

<font color="green">缺点</font>：信号线复杂, 设备成本高；  
<font color="green">优点</font>：防止总线时间浪费  

![分布式仲裁](pics/%E6%A6%82%E8%BF%B0/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BB%B2%E8%A3%81.png)

#### 4. 总线标准

对总线物理结构、功能、电气等规范统一规定

* <font color="green">物理特性</font>: 如接插头大小、引脚数量、相对位置等
* <font color="green">功能特性</font>: 描述每一信号线的功能
* <font color="green">电气特性</font>: 如信号传送方向、信号驱动能力、抗干扰能力、信号的正负逻辑等
* <font color="green">时间特性</font>: 如信号的有效时间、持续时间等

常见的总线标准

![常见的总线标准](pics/%E6%A6%82%E8%BF%B0/%E5%B8%B8%E8%A7%81%E7%9A%84%E6%80%BB%E7%BA%BF%E6%A0%87%E5%87%86.png)

并行有相互之间的干扰, 故频率高了之后难办

### 二. 接口功能与类型

IO 接口指<font color=blue>主机</font>与<font color=blue>外设</font>的交接部分, 位于<font color=blue>系统总线</font>与<font color=blue>外设</font>之间

![接口](pics/%E6%A6%82%E8%BF%B0/%E6%8E%A5%E5%8F%A3.png)

#### 1. 接口的主要功能

##### (1) 寻址

接受CPU送来的地址码, 选择接口中的寄存器(存有外设传来的数据)

##### (2) 数据缓冲

实现主机(快)与外设(慢)的速度匹配

缓冲的深度与传送的数据量(一次)(比如硬盘一次一个扇区(KB级别))有关

##### (3) 预处理

* 串-并格式转换(串行接口)
* 数据通路宽度转换(并行接口)
* 电平转换

> 主机内部并行方式, 故需要串行转并行  
> 并行的位数也可能不同, 于是需要数据通路宽度转换

##### (4) 控制逻辑

对CPU发来的控制命令进行解析, 并产生相应的操作命令发送给设备

> 如CPU对所有外设都是一个统一的READ

将设备状态信息通过总线传送给CPU

#### 2. 接口分类

##### (1) 按数据传送格式划分

###### a. 并行接口

接口与系统总线、接口、外设<font color=red>均按并行</font>方式传送数据

数据各位同事传送

适用于设备本身并行工作, 距离主机较近的场合

###### b. 串行接口

<font color=red>接口与系统总线并行</font>传送, 接口与外设<font color=red>串行传送</font>

数据<font color=red>逐位分时传送</font>

使用于设备本身串行工作, 或距主机较远, 或需要减少传送线的情况

##### (2) 按时序控制方式划分

###### a. 同步接口

接口与系统总线的信息传送由统一时序信号控制

###### b. 异步接口

接口与系统总线的信息传送采用异步应答方式

##### (3) 按IO传送控制方式划分

* a. 直接程序传送接口  
* b. 中断接口  
* c. DMA接口  

### 三. IO控制方式

主机与外设进行信息交换时，应考虑如下问题：  

(1) CPU启动外设后,在外设做准备期间(如用户按下键盘按键, 键盘将数据送到接口, 或者外设将接口的数据取走), CPU等待外设还是并行执行程序？  
(2) 如果CPU并行执行程序,外设准备好后如何通知CPU?  
(3) I/O操作通过硬件隐指令方式还是软件方式?  

对上述问题的不同方法, 有不同的<font color=red>IO控制方式</font>

* <font color=green>直接程序传送方式</font>
* <font color=green>中断方式</font> 重点
* <font color=green>DMA方式</font>

> 例子:  
> 上课时发现话筒没声音, 打电话叫设备管理人员送话筒来  
>
> 1. 等着话筒到之后再上课 - 直接程序传送方式  
> 2. 准备设备时, 继续讲课, 准备好后, 送到后敲门(通知机制), 讲课暂停, 自己去拿话筒 - 中断方式
> 3. 准备设备时, 继续讲课, 准备好后, 送给助理, 助理再给老师(有个和助理的交接过程(初始化), 对于中断方式对程序运行的影响更小) - DMA方式

|控制方式|并行|随机事件|控制方式|
|---|---|---|---|
|直接程序传送|NO|NO|软件|
|中断|YES|YES|软件|
|DMA| | | |

## 直接程序传送方式及接口

### 一. 无条件直接程序传送方式

**假设**执行IO操作时, 外部设备总是准备好

输入接口示例

也就是说外部设备总是**已经**将数据输入了缓冲器

![输入接口示例](pics/%E7%9B%B4%E6%8E%A5%E7%A8%8B%E5%BA%8F%E4%BC%A0%E9%80%81%E6%96%B9%E5%BC%8F/%E6%97%A0%E6%9D%A1%E4%BB%B6%E7%9B%B4%E6%8E%A5%E7%A8%8B%E5%BA%8F%E4%BC%A0%E9%80%81%E6%96%B9%E5%BC%8F-%E8%BE%93%E5%85%A5%E6%8E%A5%E5%8F%A3%E7%A4%BA%E4%BE%8B.png)

输出接口示例

无论怎样都把数据向缓冲器输送, 不管是否有数据

![输出接口示例](pics/%E7%9B%B4%E6%8E%A5%E7%A8%8B%E5%BA%8F%E4%BC%A0%E9%80%81%E6%96%B9%E5%BC%8F/%E6%97%A0%E6%9D%A1%E4%BB%B6%E7%9B%B4%E6%8E%A5%E7%A8%8B%E5%BA%8F%E4%BC%A0%E9%80%81%E6%96%B9%E5%BC%8F-%E8%BE%93%E5%87%BA%E6%8E%A5%E5%8F%A3%E7%A4%BA%E4%BE%8B.png)

优点: 控制软件及接口电路简单

缺点: 应用受限

### 二. 程序查询传送方式(条件传送)

外设准备期间, CPU<font color=purple>查询设备状态</font>, 设备准备好(可以送数据/读数据), 则通过IO指令与外设交换一次数据

#### (1) 外设状态

![外设状态](pics/%E7%9B%B4%E6%8E%A5%E7%A8%8B%E5%BA%8F%E4%BC%A0%E9%80%81%E6%96%B9%E5%BC%8F/%E6%9D%A1%E4%BB%B6%E4%BC%A0%E9%80%81-%E5%A4%96%E8%AE%BE%E7%8A%B6%E6%80%81.png)

<font color=green>空闲</font>: 调用前, 设备不工作

<font color=green>工作</font>: 送数据到接口或从接口读数据(同接口进行数据交换(读/写), 此时程序等待IO操作完成)

<font color=green>结束</font>: 调用后, 设备完成一次工作(接口已准备好数据/数据已被外设读走)

在**接口**中设置<font color=green>状态字</font>表示设备状态

> 再请求: 比如要读入多个按键

#### (2) 输入流程

![输入流程](pics/%E7%9B%B4%E6%8E%A5%E7%A8%8B%E5%BA%8F%E4%BC%A0%E9%80%81%E6%96%B9%E5%BC%8F/%E8%BE%93%E5%85%A5%E6%B5%81%E7%A8%8B.png)

输入接口示例

![输入接口示例](pics/%E7%9B%B4%E6%8E%A5%E7%A8%8B%E5%BA%8F%E4%BC%A0%E9%80%81%E6%96%B9%E5%BC%8F/%E8%BE%93%E5%85%A5%E6%8E%A5%E5%8F%A3%E7%A4%BA%E4%BE%8B.png)

#### (3) 输出流程

![输出流程](pics/%E7%9B%B4%E6%8E%A5%E7%A8%8B%E5%BA%8F%E4%BC%A0%E9%80%81%E6%96%B9%E5%BC%8F/%E8%BE%93%E5%87%BA%E6%B5%81%E7%A8%8B.png)

输出接口示例

![输出接口示例](pics/%E7%9B%B4%E6%8E%A5%E7%A8%8B%E5%BA%8F%E4%BC%A0%E9%80%81%E6%96%B9%E5%BC%8F/%E8%BE%93%E5%87%BA%E6%8E%A5%E5%8F%A3%E7%A4%BA%E4%BE%8B.png)

#### (4) 缺点

外设准备期间，CPU查询等待,并行程度低

CPU不能响应来自外部的随机请求(IO操作的时机是固定的)，实时性差

#### (5) 优点

控制简单, 硬件开销小

#### (6) 应用场合

对CPU效率要求不高的场合

或诊断、调试过程

## 中断方式及接口

注意中断方式不只用于IO操作

IMPORTANT

### 一. 中断基本概念

#### 1. 定义

CPU<font color="red">暂时中止现行程序的执行</font>，转去执行为某个<font color="red">随机</font>事态服务的<font color="red">中断处理程序</font>，处理完毕后<font color="red">自动恢复原程序</font>的执行

![定义](pics/%E4%B8%AD%E6%96%AD%E6%96%B9%E5%BC%8F%E5%8F%8A%E6%8E%A5%E5%8F%A3/%E5%AE%9A%E4%B9%89.png)

#### 2. 中断的实质与特点

##### (1) 中断的实质

<font color=red>程序切换</font>

切换方法

    1. 保存断点(返回地址压栈保存) (进入中断程序前)  
    2. 保护现场(寄存器数据压栈保存) (中断服务处理前, 进入中断程序后)  
    3. 恢复现场, 返回断点(中断服务处理后, 仍在中断程序中)  

切换时机: <font color=red>一条指令结束时切换</font>, 保证程序的完整性

##### (2) 特点

<font color=red>可处理随机事件</font>

* 随机事件
  * 随机发生的事态(<font color=darkred>案件、掉电等</font>)
  * 有意调用, 随机请求的事态(<font color=darkred>调用打印机</font>)
  * 随机插入的事态(<font color=darkred>软中断指令</font>, 如`INT 21H`)

程序切换花费一定时间

适合中低速IO和随机事件

<font color="darkred">注意</font><font color="red">中断</font><font color="darkred">与</font><font color="red">转子程序</font><font color="darkred">的区别</font>

> 中断处理程序针对随机事件, 调用无固定安排  
> 转子程序的调用是固定安排的

#### 3. 中断分类

##### (1) 硬中断与软中断

硬中断：由硬件请求信号引发中断

软中断：由软中断指令(`INT n`)引发中断

##### (2) 内中断与外中断

内外以主机为界

* 内中断：中断源来自主机内部  

  > 比如：除法错、溢出、软中断等

* 外中断：中断源来自主机外部，比如打印机等外设

##### (3) 可屏蔽中断与非屏蔽中断

* 可屏蔽中断：可通过<font color="red">屏蔽字</font>屏蔽**该类**中断请求(一般在接口里, 叫*中断屏蔽字寄存器*`IMR`)  
  关中断(<font color="red">中断允许标志</font>`IF=0`, 一般为`PSW`的某位)(总开关)时不响应请求
* 非屏蔽中断(NMI)：该类中断请求不受屏蔽字影响  
  请求的响应与开/关中断无关
  > 即使`IF=0`也响应  
  > 此类中断一般很重要

##### (4) 向量中断与非向量中断

向量中断：由硬件提供中断服务程序入口地址

非向量中断：由软件提供中断服务程序入口地址

#### 4. 中断典型应用

* 管理中、低速IO操作
* 故障处理
* 实时处理  
  > 事件发生时及时处理，而不是批量处理  
  > 利用时钟中断定时采集参数，检测，调节
* 人机对话
* 多机通信

#### 5. 中断系统的软硬件组织

![软硬件组织](pics/%E4%B8%AD%E6%96%AD%E6%96%B9%E5%BC%8F%E5%8F%8A%E6%8E%A5%E5%8F%A3/%E4%B8%AD%E6%96%AD%E7%B3%BB%E7%BB%9F%E8%BD%AF%E7%A1%AC%E4%BB%B6%E7%BB%84%E7%BB%87.png)

中断向量表: 中断请求源 - 中断服务程序 的映射

##### (1) 中毒请求源

![中断请求源](pics/%E4%B8%AD%E6%96%AD%E6%96%B9%E5%BC%8F%E5%8F%8A%E6%8E%A5%E5%8F%A3/%E4%B8%AD%E6%96%AD%E8%AF%B7%E6%B1%82%E6%BA%90.png)

##### (2) 中断服务程序

响应中断请求后调用的服务程序，对中断事件进行处理

##### (3) 中断向量表(中断系统的软硬件界面)

<font color=green>中断向量</font>: 中断服务程序的入口地址(还可包含状态字)

<font color=green>中断向量表</font>: 按中断类型码的顺序存放各中断向量，在一段连续的存储区
> IBM的机器中会加载到内存最低的1K中

<font color=green>向量地址</font>: 访问中断向量表内的中断向量所需的存储单元地址(存放中断向量的存储单元的地址)

> 模型机的中断向量表
> ![模型机的中断向量表](pics/%E4%B8%AD%E6%96%AD%E6%96%B9%E5%BC%8F%E5%8F%8A%E6%8E%A5%E5%8F%A3/%E6%A8%A1%E5%9E%8B%E6%9C%BA%E7%9A%84%E4%B8%AD%E6%96%AD%E5%90%91%E9%87%8F%E8%A1%A8.png)
>
> IBM PC的中断向量表  
> 注意图中间的虚线  
> IBM PC内的存储单元采用逻辑段的形式
> ![IBM PC的中断向量表](pics/%E4%B8%AD%E6%96%AD%E6%96%B9%E5%BC%8F%E5%8F%8A%E6%8E%A5%E5%8F%A3/IBM%20PC%E4%B8%AD%E6%96%AD%E5%90%91%E9%87%8F%E8%A1%A8.png)
> IBM PC的中断向量表的划分  
> ![中断向量表的划分](pics/%E4%B8%AD%E6%96%AD%E6%96%B9%E5%BC%8F%E5%8F%8A%E6%8E%A5%E5%8F%A3/IBM%20PC%E7%9A%84%E4%B8%AD%E6%96%AD%E5%90%91%E9%87%8F%E8%A1%A8%E7%9A%84%E5%88%92%E5%88%86.png)

### 二. 中断全过程(外中断)

![全过程](pics/%E4%B8%AD%E6%96%AD%E6%96%B9%E5%BC%8F%E5%8F%8A%E6%8E%A5%E5%8F%A3/%E4%B8%AD%E6%96%AD%E5%85%A8%E8%BF%87%E7%A8%8B-%E5%A4%96%E4%B8%AD%E6%96%AD%E4%B8%BA%E4%BE%8B.png)

#### 1. 中断请求信号产生

* 条件
  * <font color=red>外设工作完成</font>: 接口中“完成”标志为1
  * <font color=red>CPU允许请求</font>: 屏蔽字中对应的“<font color="red">屏蔽</font>”标志为1

* “屏蔽”对中断请求信号的产生的影响
  * 先屏蔽, 后请求  
    ![先屏蔽, 后请求](pics/%E4%B8%AD%E6%96%AD%E6%96%B9%E5%BC%8F%E5%8F%8A%E6%8E%A5%E5%8F%A3/%E5%85%88%E5%B1%8F%E8%94%BD%E5%90%8E%E8%AF%B7%E6%B1%82.png)
  * 先请求, 后屏蔽
    ![先请求, 后屏蔽](pics/%E4%B8%AD%E6%96%AD%E6%96%B9%E5%BC%8F%E5%8F%8A%E6%8E%A5%E5%8F%A3/%E5%85%88%E8%AF%B7%E6%B1%82%E5%90%8E%E5%B1%8F%E8%94%BD.png)

#### 2. 中断请求信号的传送

##### a. 使用单独请求线

![单独请求线](pics/%E4%B8%AD%E6%96%AD%E6%96%B9%E5%BC%8F%E5%8F%8A%E6%8E%A5%E5%8F%A3/%E5%8D%95%E7%8B%AC%E8%AF%B7%E6%B1%82%E7%BA%BF.png)

效率高

成本高, CPU扩展不易

##### b. 使用公共请求线

![公共请求线](pics/%E4%B8%AD%E6%96%AD%E6%96%B9%E5%BC%8F%E5%8F%8A%E6%8E%A5%E5%8F%A3/%E4%BD%BF%E7%94%A8%E5%85%AC%E5%85%B1%E8%AF%B7%E6%B1%82%E7%BA%BF.png)

对CPU影响小, 扩展容易, 成本低

效率低

##### c. 采用二维结构

折衷方案，不同中断请求线优先级不同

![二维结构](pics/%E4%B8%AD%E6%96%AD%E6%96%B9%E5%BC%8F%E5%8F%8A%E6%8E%A5%E5%8F%A3/%E4%BA%8C%E7%BB%B4%E7%BB%93%E6%9E%84.png)

##### d. 混合结构

如非屏蔽中断请求采用单独请求线, 其他采用公共请求线

![混合结构](pics/%E4%B8%AD%E6%96%AD%E6%96%B9%E5%BC%8F%E5%8F%8A%E6%8E%A5%E5%8F%A3/%E6%B7%B7%E5%90%88%E7%BB%93%E6%9E%84.png)

#### 3. 中断判优

##### (1) 不同事件的优先级顺序

故障中断、DMA(实际上不是中断, 但也需要中断来触发)、外中断（先输入后输出）

##### (2) CPU现行程序与外部请求的判优

* a. CPU设置中断允许标志`IF` (模型机)
  * `IF = 0` 关中断
  * `IF = 1` 开中断
* b. CPU设置程序状态字的优先级字段
  * <font color=blue>为现行程序</font>赋予优先级
    * < 外设请求优先级, 相应中断
    * $\geq$等于外设请求优先级, 不相应中断

##### (3) 外设请求判优

###### a. 软件判优

由程序查询确定优先级, 可灵活修改优先级

CPU只有单根中断请求线

![软件判优](pics/%E4%B8%AD%E6%96%AD%E6%96%B9%E5%BC%8F%E5%8F%8A%E6%8E%A5%E5%8F%A3/%E8%BD%AF%E4%BB%B6%E5%88%A4%E4%BC%98.png)

> 左图表明中断请求信号的产生; 右图表明CPU对中断请求信号的处理, 确定中断请求来源  
> 优先级取决于查询的顺序

灵活性强, 效率低

###### b. 硬件判优

* 一种采用独立请求线的并行判优逻辑

优先级顺序固定, 左边的设备的请求会封锁右边设备的请求

![一种采用独立请求线的并行判优逻辑](pics/%E4%B8%AD%E6%96%AD%E6%96%B9%E5%BC%8F%E5%8F%8A%E6%8E%A5%E5%8F%A3/%E4%B8%80%E7%A7%8D%E9%87%87%E7%94%A8%E7%8B%AC%E7%AB%8B%E8%AF%B7%E6%B1%82%E7%BA%BF%E7%9A%84%E5%B9%B6%E8%A1%8C%E5%88%A4%E4%BC%98%E9%80%BB%E8%BE%91.png)

* 链式优先排队逻辑

CPU只有单根中断请求线, 相比独立请求线, 可以减少传输线路、CPU引脚、且相对容易扩展

优先级顺序固定

![链式优先排队逻辑](pics/%E4%B8%AD%E6%96%AD%E6%96%B9%E5%BC%8F%E5%8F%8A%E6%8E%A5%E5%8F%A3/%E9%93%BE%E5%BC%8F%E4%BC%98%E5%85%88%E6%8E%92%E9%98%9F%E9%80%BB%E8%BE%91.png)

* 专用芯片判优

<font color=blue>中断控制器</font>(以<font color=red>8259</font>为例)

中断控制器集中解决请求信号的接收、屏蔽、判优、编码等问题

![8259](pics/%E4%B8%AD%E6%96%AD%E6%96%B9%E5%BC%8F%E5%8F%8A%E6%8E%A5%E5%8F%A3/8259%E4%B8%AD%E6%96%AD%E6%8E%A7%E5%88%B6%E5%99%A8.png)

> `IR`用于接受不同中断源的请求信号  
> `D`为数据引脚, 用于接受芯片初始化信息(从CPU)、送出判优结果(中断号)  
> `A0`接地址线(访问芯片寄存器)  
> `CS`片选(访问芯片寄存器)  
> `RD WR`区分读写方向  
> `SP/EN`确定主从芯片  
> `INT`输出(向CPU)中断请求信号  
> `INTA`接受(从CPU输入)中断相应信号

简化的内部结构

![内部结构1](pics/%E4%B8%AD%E6%96%AD%E6%96%B9%E5%BC%8F%E5%8F%8A%E6%8E%A5%E5%8F%A3/8259%E5%86%85%E9%83%A8%E7%AE%80%E5%8C%961.png)

> 中断服务寄存器: 记录正在处理的中断(有嵌套的情况下, 可能有多位为一)  
> 左边的例子: 2号请求被屏蔽, 当前正在处理3, 有个4号请求, 由于优先级, 不发新的中断请求  
> 右边的例子: 没有屏蔽, 2号优先级高于正在服务的3号请求, 如果运行嵌套, 就会发一个2号请求给CPU

![内部2](pics/%E4%B8%AD%E6%96%AD%E6%96%B9%E5%BC%8F%E5%8F%8A%E6%8E%A5%E5%8F%A3/8259%E5%86%85%E9%83%A8%E7%AE%80%E5%8C%962.png)

#### 4. 中断响应

##### (1) 相应中断的条件

1. 有中断请求信号，且未被屏蔽
2. CPU处于开中断状态(IF=1)
3. 没有优先权更高的事件要处理(如故障引起的内部中断，或DMA请求等)
4. 上一条指令不是停机指令
5. 在一条指令结束时响应(ET结束之后)

##### (2) 相应过程 - 以模型机为例

主程序现行指令执行周期(ET)的最后一个节拍，响应INTR请求，向中断源发响应信号$\overline{INTA}$

主程序现行指令结束后进入<font color="red">中断周期（IT）</font>，该周期为一个<font color="red">过渡周期</font>,任务是<font color="red">保存断点、获取中断服务程序入口地址</font>

* IT周期的操作流程

![IT周期的操作流程](pics/%E4%B8%AD%E6%96%AD%E6%96%B9%E5%BC%8F%E5%8F%8A%E6%8E%A5%E5%8F%A3/IT%E5%91%A8%E6%9C%9F%E7%9A%84%E6%93%8D%E4%BD%9C%E6%B5%81%E7%A8%8B.png)

* 中断服务程序入口地址获取方式

<font color=orange>向量中断</font>: 由<font color="blue">硬件</font>根据<font color="blue">中断类型号</font>产生向量地址，查询中断向量表，获取中断服务程序的入口地址

<font color=orange>非向量中断</font>: 响应时首先转向中断查询程序，通过<font color="blue">软件查询方式</font>确定中断源，获取相应的中断服务程序入口地址

#### 5. 中断处理

CPU 执行中断服务程序

##### (1) 单级中断

CPU响应后只处理一个中断源的请求，处理完毕后才能响应新的请求

![单级中断](pics/%E4%B8%AD%E6%96%AD%E6%96%B9%E5%BC%8F%E5%8F%8A%E6%8E%A5%E5%8F%A3/%E5%8D%95%E7%BA%A7%E4%B8%AD%E6%96%AD.png)

> 不能再返回后开中断, 之后原程序直接继续运行了, 无法及时响应其他中断

##### (2) 多重中断

在中断服务过程中，允许响应处理更高级别的中断请求

![多重中断](pics/%E4%B8%AD%E6%96%AD%E6%96%B9%E5%BC%8F%E5%8F%8A%E6%8E%A5%E5%8F%A3/%E5%A4%9A%E9%87%8D%E4%B8%AD%E6%96%AD.png)

> 开中断1: 之前有关中断  
> 关中断1: 恢复时不希望受影响  
> 开中断2: 回到上一级后可以响应新请求  

示例:

![允许多重中断的嵌套形式](pics/%E4%B8%AD%E6%96%AD%E6%96%B9%E5%BC%8F%E5%8F%8A%E6%8E%A5%E5%8F%A3/%E5%85%81%E8%AE%B8%E5%A4%9A%E9%87%8D%E4%B8%AD%E6%96%AD%E7%9A%84%E5%B5%8C%E5%A5%97%E5%BD%A2%E5%BC%8F.png)

### 三. 中断接口

接口地址译码也可为寄存器选择

![接口](pics/%E4%B8%AD%E6%96%AD%E6%96%B9%E5%BC%8F%E5%8F%8A%E6%8E%A5%E5%8F%A3/%E4%B8%AD%E6%96%AD%E6%8E%A5%E5%8F%A3.png)

> 接口板: 每个外部设备都有独立的此部分  
> 主机板: 放在主板, 外部设备共用

#### 1. 组成(寄存器级)

##### (1) 端口地址译码

对接口寄存器寻址

##### (2) 命令字寄存器

接收CPU发向外设的命令字，转换为相应操作命令送外设

<font color=darkred>命令字格式拟定</font>

* 用代码表示各种命令
  * 代码位数
  * 代码含义

##### (3) 状态字寄存器

反映设备和接口运行状态

<font color=darkred>状态字格式的拟定</font>

用代码表示各种状态

##### (4) 数据缓冲器

传送数据, 实现缓冲

* 单向(显示器、打印机)/双向(硬盘)

* 缓冲深度(键盘:一个双字之类的; 打印机: 可能一次一行信息; 显示器: 一帧信息)

##### (5) 控制逻辑

* 请求信号产生逻辑(图中`IRQi`)
* 电平转换逻辑
* 串-并转换逻辑(仅串口接口)
* 扩展中断源

##### (6) 中断控制器(公用)

* 接受外设请求
* 判优
* 送出中断请求(送CPU)
* 接受中断响应(来自CPU)
* 送出中断号(中断类型码)

#### 2. 工作过程(外中断)

1. 设置工作方式, 送屏蔽字, 送中断号高位(数据线`D7-D0`有8位, 而 `IRQ` 共8个,只需要三位, 此时就需要约定使用数据线的哪几位)
2. 发启动命令(送命令字)启动设备
3. 设备完成工作,请求中断
4. 中断控制器汇集各中断请求, 判优, 向CPU送INT, 并形成中断号
5. CPU 响应 INT, 发$\overline{INTA}$
6. 中断控制器送出中断号
7. CPU执行<font color=red>中断隐指令</font>操作(IT周期), 进入服务程序

## DMA 方式及接口

### 一. DMA方式基本概念

#### 1. 定义

<font color="orange">DMA</font>：直接存储器访问（Direct Memory Access），依靠硬件直接在<font color="orange">主存与外围设备</font>之间进行数据传送，在传送过程中<font color="orange">不需要CPU的干预</font>

#### 2. 实质与特点

<font color="orange">实质：总线权切换</font>(直接数据传送占用总线, DMA之前CPU要让出总线控制权)(没有程序切换)  
<font color="orange">特点</font>：随机性；并行性(外设准备 以及 数据传送时(这个中断不行))；处理<font color="red">简单</font>批量高速数据传送

#### 3. 典型应用

主存与高速I/O外设间的简单数据传送，比如：<font color="red">磁盘调用、DRAM自动刷新</font>

实时高速数据采集，比如实时音频、视频采集等

* DMA 响应流程

![DMA响应流程](pics/DMA%E6%96%B9%E5%BC%8F%E5%8F%8A%E6%8E%A5%E5%8F%A3/DMA%E5%93%8D%E5%BA%94%E6%B5%81%E7%A8%8B.png)

> CPU的`HOLD`引脚接受DMA请求  
> 上图为模型机的情况, 在实际的机器里, DMA请求的响应不会等到指令执行结束, 一般在总线周期的结束(不绝对, 但一定在一次总线访问结束后, 故DMA不影响程序执行的完整性)

### 二. DMA控制器与接口的连接

![硬件设置](pics/DMA%E6%96%B9%E5%BC%8F%E5%8F%8A%E6%8E%A5%E5%8F%A3/DMA%E7%A1%AC%E4%BB%B6%E8%AE%BE%E7%BD%AE.png)

![硬件设置2](pics/DMA%E6%96%B9%E5%BC%8F%E5%8F%8A%E6%8E%A5%E5%8F%A3/DMA%E7%A1%AC%E4%BB%B6%E8%AE%BE%E7%BD%AE2.png)

#### 1. DMA控制器功能

<font color=orange>初始化</font>: 接收初始化信息(传送方向、主存首址、交换量)

<font color=orange>传送前</font>: 接收外设DMA请求，判优，向CPU申请总线控制权

<font color=orange>传送期间</font>:接管总线权，发地址、读/写命令

#### 2. 接口信息

<font color=orange>初始化</font>: 接收初始化信息(外设寻址信息)

<font color=orange>传送前, 外设准备好</font>: 向DMA控制器发请求

<font color=orange>传送期间</font>: 传送数据

### 磁盘的DMA传输过程

![磁盘的DMA传送过程](pics/DMA%E6%96%B9%E5%BC%8F%E5%8F%8A%E6%8E%A5%E5%8F%A3/%E7%A3%81%E7%9B%98%E7%9A%84DMA%E4%BC%A0%E8%BE%93%E8%BF%87%E7%A8%8B.png)
